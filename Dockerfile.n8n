FROM n8nio/n8n:latest

# Ð Ð°Ð±Ð¾Ñ‚Ð°ÐµÐ¼ Ð¿Ð¾Ð´ root Ð´Ð»Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²
USER root

# Ð¤Ð¸ÐºÑ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ Alpine + Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ
RUN set -eux; \
  printf '%s\n' \
    "https://dl-cdn.alpinelinux.org/alpine/v3.22/main" \
    "https://dl-cdn.alpinelinux.org/alpine/v3.22/community" \
  > /etc/apk/repositories; \
  apk update; \
  apk upgrade --no-cache

# Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ðµ Ð¿Ð°ÐºÐµÑ‚Ñ‹ (Ð´Ð¾Ð±Ð°Ð²Ð¸Ð» ffmpeg Ð´Ð»Ñ moviepy)
RUN apk add --no-cache \
  bash \
  curl \
  git \
  make \
  g++ \
  gcc \
  python3 \
  py3-pip \
  libffi-dev \
  yt-dlp \
  apache2-utils \
  ffmpeg

# Ð§ÑƒÑ‚ÑŒ ÑƒÑÐºÐ¾Ñ€Ð¸Ð¼ npm
RUN npm config set fund false && npm config set audit false

# Ð’Ñ‹Ð´ÐµÐ»ÐµÐ½Ð½Ñ‹Ð¹ ÐºÐ°Ñ‚Ð°Ð»Ð¾Ð³ Ñ Ð¿Ð¸Ñ‚Ð¾Ð½Ð¾Ð²ÑÐºÐ¸Ð¼Ð¸ Ð»Ð¸Ð±Ð°Ð¼Ð¸ â€” ÐºÐ°Ðº Ñƒ Ð½Ð°Ñ Ð±Ñ‹Ð»Ð¾
RUN mkdir -p /opt/instagrapi

# Ð¡Ñ‚Ð°Ð²Ð¸Ð¼ Ð¿Ð¸Ñ‚Ð¾Ð½-Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ¸ Ñ€Ð¾Ð²Ð½Ð¾ Ñ‚ÑƒÐ´Ð° (ÐºÐ°Ðº Ð² ÑƒÐ´Ð°Ñ‡Ð½Ð¾Ð¹ ÑÑ…ÐµÐ¼Ðµ)
RUN pip install --no-cache-dir --target=/opt/instagrapi \
    "instagrapi==2.1.5" \
    "requests>=2.31.0" \
    "Pillow>=8.1.1" \
    "moviepy>=1.0.3" \
    "typing-extensions" \
    "pydantic<3" \
    "pydantic-core<3"

# ÐŸÐ°Ñ‚Ñ‡ Ð½Ð° pinned_channels_info, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ Ð¿Ð°Ð´Ð°Ð»Ð¾ Ð½Ð° Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‰ÐµÐ¼ ÐºÐ»ÑŽÑ‡Ðµ
RUN sed -i 's/data\["pinned_channels_info"\]\["pinned_channels_list"\]/data.get("pinned_channels_info", {}).get("pinned_channels_list", [])/' /opt/instagrapi/instagrapi/extractors.py || true

# Ð¢Ð’ÐžÐ˜ npm-Ð³Ð»Ð¾Ð±Ð°Ð»ÐºÐ¸ (Ð¾ÑÑ‚Ð°Ð²Ð»ÑÑŽ, ÐºÐ°Ðº Ñ‚Ñ‹ Ð¿Ñ€Ð¾ÑÐ¸Ð» â€” Ð½Ð¸Ñ‡ÐµÐ³Ð¾ Ð½Ðµ ÑƒÐ´Ð°Ð»ÑÑŽ)
RUN for pkg in \
    axios \
    node-fetch \
    form-data \
    moment \
    date-fns \
    lodash \
    fs-extra \
    path \
    csv-parser \
    xml2js \
    js-yaml \
    xlsx \
    jsonwebtoken \
    simple-oauth2 \
    uuid \
    openai \
    @tensorflow/tfjs-node \
    langchain \
    node-telegram-bot-api \
    discord.js \
    vk-io \
    whatsapp-web.js \
    fluent-ffmpeg \
    ffmpeg-static \
    google-tts-api \
    @vitalets/google-translate-token \
    node-wav \
    mongoose \
    ioredis \
    bcrypt \
    validator \
    joi \
    winston \
    dotenv \
    prom-client \
    node-downloader-helper \
    adm-zip \
    archiver \
  ; do \
    echo "ðŸ”§ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ $pkg..." && npm install -g "$pkg" || echo "âš ï¸ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ $pkg, Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶Ð°ÐµÐ¼..."; \
  done

# Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾ â€” Ð´Ð»Ñ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚Ð¸ Ð² Code-Ð½Ð¾Ð´Ð°Ñ…
RUN npm install oauth-1.0a

# Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ node
USER node
